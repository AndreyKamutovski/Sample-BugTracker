<div *ngIf="errors.length === 0" style="margin: 10% 0;">
  <span class="mat-h1">В проекте отсутствуют ошибки. Нажмите кнопку 'Добавить ошибку' для добавления ошибки</span>&nbsp;
  <button mat-raised-button color="accent" (click)="openAddErrorDialog()">Добавить ошибку</button>
</div>
<div class="mat-elevation-z5 table-container" [hidden]="!(errors.length > 0)">

  <div class="error-global-filter">
    <mat-form-field>
      <input matInput type="text" size="50" placeholder="Глобальный фильтр" (input)="errorsTable.filterGlobal($event.target.value, 'contains')">
    </mat-form-field>
  </div>


  <p-table #errorsTable [columns]="cols" [(value)]="errors" [paginator]="true" [rows]="5" [responsive]="true" [scrollable]="true"
    scrollHeight="500px" [resizableColumns]="true">
    <ng-template pTemplate="header" let-columns>
      <tr>
        <th *ngFor="let col of cols" [pSortableColumn]="col.field">
          {{col.header}}
          <p-sortIcon [field]="col.field"></p-sortIcon>
        </th>
      </tr>
      <tr>
        <th *ngFor="let col of columns" [ngSwitch]="col.field">
          <input *ngSwitchCase="'Title'" pInputText type="text" (input)="errorsTable.filter($event.target.value, col.field, col.filterMatchMode)">
          <mat-select *ngSwitchCase="'EmailErrorAuthor'" placeholder="Все пользователи" multiple (selectionChange)="errorsTable.filter($event.value, col.field, 'in')">
            <mat-option *ngFor="let user of projectUsers" [value]="user.Email">
              {{user.Email | getUserNameFromEmail}}
            </mat-option>
          </mat-select>
          <mat-select *ngSwitchCase="'EmailAssignee'" placeholder="Все пользователи" multiple (selectionChange)="errorsTable.filter($event.value, col.field, 'in')">
            <mat-option *ngFor="let worker of projectWorkers" [value]="worker.Email">
              {{worker.Email | getUserNameFromEmail}}
            </mat-option>
          </mat-select>
          <mat-select *ngSwitchCase="'Status'" placeholder="Все" multiple (selectionChange)="errorsTable.filter($event.value, col.field, 'in')">
            <mat-option *ngFor="let status of errorService.status" [value]="status.value">
              {{status.viewValue}}
            </mat-option>
          </mat-select>
          <mat-select *ngSwitchCase="'Priority'" placeholder="Все" multiple (selectionChange)="errorsTable.filter($event.value, col.field, 'in')">
            <mat-option *ngFor="let priority of errorService.priorities" [value]="priority.value">
              {{priority.viewValue}}
            </mat-option>
          </mat-select>
          <mat-select *ngSwitchCase="'Classification'" placeholder="Все" multiple (selectionChange)="errorsTable.filter($event.value, col.field, 'in')">
            <mat-option *ngFor="let classification of errorService.classification" [value]="classification.value">
              {{classification.viewValue}}
            </mat-option>
          </mat-select>
        </th>

      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-error>
      <tr [pSelectableRow]="error">
        <td>
          <a href="#" (click)="openErrorDialog(error)">{{ error.Title }}</a>
        </td>
        <td>{{ error.EmailAuthor | getUserNameFromEmail }}</td>
        <td>{{ error.DateCreation | date:'longDate' }}</td>
        <td>
          <mat-select placeholder="Не назначен" [(value)]="error.EmailAssignee" (selectionChange)="updateError(error, 'Ответственный за ошибку')">
            <mat-option [value]="null"> Не назначен </mat-option>
            <mat-option *ngFor="let worker of projectWorkers" [value]="worker.Email">
              {{worker.Email | getUserNameFromEmail}}
            </mat-option>
          </mat-select>
        </td>
        <td>
          <div [ngSwitch]="permissionService.Permission.includes(permissionService.PERMISSION_LIST.EDITING_DEADLINE_OF_ERROR)">
            <mat-form-field *ngSwitchCase="true" style="width: 95%;" floatLabel="never">
              <input matInput style="color: black;" placeholder="Не установлен" [min]="error.DateCreation" [matDatepicker]="deadlineDatepicker"
                disabled [(ngModel)]="error.Deadline" (dateChange)="updateError(error, 'Срок выполнения')">
              <mat-datepicker-toggle matSuffix [for]="deadlineDatepicker"></mat-datepicker-toggle>
              <mat-datepicker #deadlineDatepicker disabled="false"></mat-datepicker>
            </mat-form-field>
            <span *ngSwitchDefault>
              {{error.Deadline ? (error.Deadline | date:'longDate') : 'Не установлен' }}
            </span>
          </div>
        </td>
        <td> 
          <div [ngSwitch]="permissionService.Permission.includes(permissionService.PERMISSION_LIST.EDITING_STATUS_OF_ERROR)">
            <mat-select [(value)]="error.Status" (selectionChange)="errorService.updateStatus(error.ErrorId, $event.value).then(showUpdatedMsg('Статус ошибки'))">
              <mat-option *ngFor="let status of errorService.status" [value]="status.value">
                {{status.viewValue}}
              </mat-option>
            </mat-select>
            <span *ngSwitchDefault>
              {{error.Status ? error.Status : 'Не установлен' }}
            </span>
          </div>



        </td>
        <td>
          <mat-select [(value)]="error.Priority" (selectionChange)="updateError(error, 'Приоритет ошибки')">
            <mat-option *ngFor="let priority of errorService.priorities" [value]="priority.value">
              {{priority.viewValue}}
            </mat-option>
          </mat-select>
        </td>
        <td>
          <mat-select [(value)]="error.Classification" (selectionChange)="updateError(error, 'Классификация ошибки')">
            <mat-option *ngFor="let classification of errorService.classification" [value]="classification.value">
              {{classification.viewValue}}
            </mat-option>
          </mat-select>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <button mat-fab class="mat-fab-buttom-right" (click)="openAddErrorDialog()">
    <mat-icon>add</mat-icon>
  </button>
</div>